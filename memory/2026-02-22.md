# 2026-02-22 - MagicStory Development Log

## Completed Today

### ✅ Feature: Remove Favorite Hero
- Simplified character creation by removing hero type selection
- Removed `favorite_hero` from database, types, and UI
- Updated `createChildProfile()` and `updateChildProfile()` functions

### ✅ Security: RLS Policy Fix (Critical)
- Fixed overly permissive policies allowing all users to see all data
- Implemented strict user isolation: users can only access their own data
- Fixed stories, profiles, and hero_relationships RLS policies

### ✅ Feature: Runes System
- Created `user_runes` and `rune_transactions` tables
- SQL functions: `spend_runes()`, `add_runes()`, `refund_runes()`
- New users get 3 free runes on signup
- Rune cost: 1 for linear stories, 2 for interactive
- Created `RuneBalance` component and `/runes` page

### ✅ Feature: Story Rating System
- Added `rating` column to stories table
- Created `StarRating` component with 5-star UI
- Integrated rating at end of stories and in library

### ✅ Feature: Web Speech API Audio
- Created `StoryAudioPlayer` component with play/pause/stop
- SSR-safe implementation with client-side detection
- French voice priority (Google/Microsoft)

### ✅ UI: Parent Page Redesign
- Mobile-first design with 2-column grid for hero cards
- Simplified cards: avatar, name, age, traits as emojis
- Changed terminology: "children" → "heroes" throughout app
- Removed relationship management (HeroRelations component)

### ✅ UI: Choose-Hero Page Redesign
- 3-step progressive flow: Hero → World → Theme
- 9 worlds: Forest, Castle, Ocean, Space, Mountain, Garden, Cloud, Volcano, Ghost
- 6 themes: Adventure, Friendship, Discovery, Courage, Magic, Mystery
- Added "Random" buttons for world and theme selection
- Visual progress bar, large emoji cards, cartoon borders

### ✅ Fix: Authentication Magic Links
- Created client-side `/auth/callback/page.tsx`
- Better error handling and user feedback during auth
- Fixed session verification after code exchange

## Technical Decisions
- Moved shared types to `lib/types.ts` to avoid 'use server' export restrictions
- Type Safety prioritized to prevent React Client Manifest errors
- SSR safety: All browser APIs wrapped in useEffect with isClient checks

## Database Migrations to Run (if not done)
- `20260220160000_secure_rls_policies.sql` (security)
- `20260221000000_create_runes_system.sql` (runes)
- `20260221100000_add_story_rating.sql` (ratings)

## Notes
- Build fixes applied for TypeScript errors and hydration issues
- Audio quality via Web Speech API varies by browser (Chrome best)
- Consider upgrading to ElevenLabs if quality insufficient for children
